<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.srm.dao.srm.IRequestDao">
	<insert id="insertRequest" parameterType="com.oti.srm.dto.Request" >
		insert into requests (RNO, REQ_DATE, REQ_TITLE, REQ_CONTENT, CLIENT, SNO, REQ_EXPECT_DATE, STATUS_NO)
		values(SEQ_REQUESTS.nextval, sysdate, #{reqTitle}, #{reqContent}, #{client}, #{sno}, #{reqExpectDate}, #{statusNo})
	</insert>
	
	<select id="getRequestList" resultType="com.oti.srm.dto.Request">
		select RNO, REQ_DATE as "reqDate", REQ_TITLE as "reqTitle", REQ_CONTENT as "reqContent",
				CLIENT, SNO, REQ_EXPECT_DATE as "reqExpectDate", STATUS_NO as "statusNo"
    	from requests
	</select>
	
	<select id="getPresentStep" parameterType="int" resultType="int">
		select NEXT_STATUS
			from (
			    select rownum as rnum, NEXT_STATUS,CHANGE_DATE
			        from(
			            select rownum, NEXT_STATUS,CHANGE_DATE from status_histories
			            where rno = #{rno}
			            order by CHANGE_DATE desc
			            )
			    order by rnum
			    )
		where rnum=1
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<select id="countPm" parameterType="int" resultType="int">
		select count(*)
		from requests
	</select>
	<select id="selectAll" parameterType="com.oti.srm.dto.Request" resultType="com.oti.srm.dto.SelectPM">
		<![CDATA[
		select rownum, jj.RNO, jj.REQ_DATE as "reqDate" , jj.REQ_TITLE as "reqTitle", jj.REQ_CONTENT as "reqContent", 
                jj.CLIENT, jj.SNO, jj.REQ_EXPECT_DATE as "reqExpectDate", jj.STATUS_NO as "statusNo",
                jj.REQ_TYPE as "reqType" , jj.DEVELOPER, jj.TESTER, jj.DISTRIBUTOR, jj.PM, jj.USER_TESTER
		from(
		        select j.RNO, j.REQ_DATE, j.REQ_TITLE, j.REQ_CONTENT, j.CLIENT, j.SNO, j.REQ_EXPECT_DATE, j.STATUS_NO,
		                j.REQ_TYPE, j.DEVELOPER, j.TESTER, j.DISTRIBUTOR, j.PM, j.USER_TESTER
		            from (
		            select rownum as rnum, r.RNO, r.REQ_DATE, r.REQ_TITLE, r.REQ_CONTENT, r.CLIENT, r.SNO, r.REQ_EXPECT_DATE, r.STATUS_NO,
		                    rp.REQ_TYPE, rp.DEVELOPER, rp.TESTER, rp.DISTRIBUTOR, rp.PM, rp.USER_TESTER
		            from requests r inner join request_process rp
		            on r.RNO = rp.RNO
		 
		            order by r.req_date desc
		            ) j
		        where rnum <= #{endRowNo}
		    ) jj where rownum >=#{startRowNo}
		]]>
	</select>
	


</mapper>