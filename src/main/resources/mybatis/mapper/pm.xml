<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.srm.dao.srm.IPMDao">
	<select id="selectStaffBySno" parameterType="map" resultType="com.oti.srm.dto.Member">
		select MID, MNAME, MTYPE	    	
	    from MEMBERS
	    where SNO=#{sno} and MTYPE=#{mtype}	
	</select>	
	<select id="selectQuota" parameterType="map" resultType="int">
		select count(*) as quota 
		from REQUEST_PROCESS 
		<where>
		<if test="mtype == 'developer'">
			DEV_COMP_DATE is null and DEVELOPER
		</if>
		<if test="mtype == 'tester'">
			TEST_COMP_DATE is null and TESTER
		</if>
		<if test="mtype == 'usertester'">
			USERTEST_COMP_DATE is null and USER_TESTER
		</if>
		<if test="mtype == 'distributor'">
			DIST_COMP_DATE is null and DISTRIBUTOR
		</if>
		=#{mid}
		</where> 
	</select>	
	<insert id="insertRequestProcess" parameterType="com.oti.srm.dto.RequestProcess">
		insert into REQUEST_PROCESS
		(RNO, REQ_TYPE, PRIORITY, ALL_EXPECT_DATE, DEVELOPER, TESTER, USER_TESTER, DISTRIBUTOR, PM)
		values 
		(#{rno}, #{reqType}, #{priority}, #{allExpectDate}, #{developer}, #{tester}, #{userTester}, #{distributor}, #{pm})
	</insert>
	
	<select id="selectWorkingInfo" parameterType="com.oti.srm.dto.Member" resultType="com.oti.srm.dto.WorkingInfo">
		select 
			r.rno as "rno",
			sh.change_date as "startDate",
			usertest_expect_date as "endExpectDate"
		from requests r, request_process rp, status_histories sh
		<where> r.rno = rp.rno 
			and r.rno = sh.rno
			<if test="mtype == 'developer'">
				and user_tester = #{mid}
				and status_no = 4
				and next_status = 4
			</if>
			<if test="mtype == 'tester'">
				and tester = #{mid}
				and status_no = 6
				and next_status = 6
			</if>
			<if test="mtype == 'usertester'">
				and user_tester = #{mid}
				and status_no = 8
				and next_status = 8
			</if>
			<if test="mtype == 'distributor'">
				and user_tester = #{mid}
				and status_no = 10
				and next_status = 10
			</if>
		</where>
	</select>
	
	
</mapper>