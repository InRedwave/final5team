<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oti.srm.dao.srm.ICommonDao">
	<select id="selectRequestHistories" parameterType="int" resultType="com.oti.srm.dto.StatusHistory">
		select
	    	hno as "hno",
	        change_date as "changeDate",
	        sh.rno as "rno",
	        next_status as "nextStatus",
	        status_name as "statusName",
	        reply as "reply",
	        dist_source as "distSource",
	        writer as "writer"
		from status_histories sh, status s
		where sh.next_status = s.status_no 
		and sh.rno = #{rno}
		order by change_date asc
	</select>
	
	<select id="selectStatusHistoryFiles" parameterType="int" resultType="com.oti.srm.dto.StatusHistoryFile">
		select
	    	fno as "fno",
	    	saved_date as "savedDate",
	    	file_name as "fileName",
	    	file_type as "fileType",
	    	file_data as "fileData",
	    	hno as "hno"
		from status_histories_files
		where hno = #{hno}
	</select>
	
	<select id="selectRequest" parameterType="int" resultType="com.oti.srm.dto.Request">
		select
	    	rno as "rno",
	    	req_date as "reqDate",
	    	req_title as "reqTitle",
	    	req_content as "reqContent",
	    	client as "client",
	    	mname as "clientName",
	    	r.sno as "sno",
	    	system_name as "systemName",
	    	req_expect_date as "reqExpectDate",
	    	r.status_no as "statusNo",
	    	status_name as "statusName",
	    	m.organ as "organ"
		from requests r, status s, systems sy, members m
		where s.status_no = r.status_no 
		and r.sno = sy.sno
		and r.client = m.mid
		and rno = #{rno}
	</select>
	
	<select id="selectRequestProcess" parameterType="int" resultType="com.oti.srm.dto.RequestProcess">
		select
	    	rno as "rno",
	    	req_type as "reqType",
	    	priority as "priority",
	    	dev_expect_date as "devExpectDate",
	    	test_expect_date as "testExpectDate",
	    	dist_expect_date as "distExpectDate",
	    	all_expect_date as "allExpectDate",
	    	usertest_expect_date as "userTestExpectDate",
	    	dev_comp_date as "devCompDate",
	    	test_comp_date as "testCompDate",
	    	dist_comp_date as "distCompDate",
	    	all_comp_date as "allCompDate",
	    	usertest_comp_date as "userTestCompDate",
	    	pm as "pm",
	    	developer as "developer",
	    	tester as "tester",
	    	distributor as "distributor",
	    	user_tester as "userTester"
		from request_process
		where rno = #{rno}
	</select>
	
	<select id="selectRequestFiles" parameterType="int" resultType="com.oti.srm.dto.StatusHistoryFile">
		select 
			fno as "fno",
			saved_date as "savedDate",
			file_name as "fileName",
			file_type as "fileType",
			file_data as "fileData",
			sh.hno as "hno"
		from status_histories sh, status_histories_files shf 
		where sh.hno = shf.hno
		and sh.rno = #{rno}
		and sh.next_status = 1
	</select>
	
	<update id="updateExpectDate" parameterType="map">
		update request_process 
		<set>
			<if test="mtype == 'pm'">
				all_expect_date = #{expectDate},
			</if>
			<if test="mtype == 'developer'">
				dev_expect_date = #{expectDate},
			</if>
			<if test="mtype == 'tester'">
				test_expect_date = #{expectDate},
			</if>
			<if test="mtype == 'usertester'">
				usertest_expect_date = #{expectDate},
			</if>
			<if test="mtype == 'distributor'">
				dist_expect_date = #{expectDate}
			</if>
		</set> 
		where rno = #{rno} 
	</update>
	
	<update id="updateCompDate" parameterType="map">
		update request_process 
		<set>
			<if test="mtype == 'pm'">
				all_comp_date = sysdate,
			</if>
			<if test="mtype == 'developer'">
				dev_comp_date = sysdate,
			</if>
			<if test="mtype == 'tester'">
				test_comp_date = sysdate,
			</if>
			<if test="mtype == 'usertester'">
				usertest_comp_date = sysdate,
			</if>
			<if test="mtype == 'distributor'">
				dist_comp_date = sysdate
			</if>
		</set> 
		where rno = #{rno} 
	</update>
	
	<insert id="insertStatusHistory" parameterType="com.oti.srm.dto.StatusHistory">
		<selectKey keyProperty="hno" resultType="int" order="BEFORE">
          SELECT seq_status_histories.nextval FROM dual
       </selectKey>		
		insert into status_histories
		(hno, change_date, rno, reply, next_status, dist_source, writer)
		values 
		(#{hno}, sysdate, #{rno}, #{reply}, #{nextStatus}, #{distSource}, #{writer})
	</insert>
	
	<update id="updateRequestStatus" parameterType="map">
		update requests
		set
			status_no = #{statusNo}
		where rno = #{rno}
	</update>
	
	<insert id="insertStatusHistoryFile" parameterType="com.oti.srm.dto.StatusHistoryFile">
		insert into status_histories_files
		values
		(seq_status_histories_files.nextval, sysdate, #{fileName}, #{fileType}, #{fileData}, #{hno})
	</insert>
	
	<select id="selectRequestRecentPM" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from requests
		where status_no = 1
	</select>
	
	<select id="selectRequestRecent" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from request_process
		<where>
			<if test="mtype == 'developer'">
				developer = #{mid}
			and dev_expect_date is null
			</if>
			<if test="mtype == 'tester'">
				tester = #{mid}
			and test_expect_date is null
			</if>
			<if test="mtype == 'usertester'">
				user_tester = #{mid}
			and usertest_expect_date is null
			</if>
			<if test="mtype == 'distributor'">
				distributor = #{mid}
			and dist_expect_date is null
			</if>
		</where>
	</select>	
	
	<select id="selectRequestInProgress" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from request_process rp, requests r
		<where>rp.rno = r.rno
		
			<if test="mtype == 'pm'">
				and r.STATUS_NO between  2 and 11
				and pm = #{mid}
			</if>
			<if test="mtype == 'developer'">
				and r.STATUS_NO = 4
				and developer = #{mid}
			</if>
			<if test="mtype == 'tester'">
				and r.STATUS_NO = 6
				and tester = #{mid}
			</if>
			<if test="mtype == 'usertester'">
				and r.STATUS_NO = 8
				and user_tester = #{mid}
			</if>
			<if test="mtype == 'distributor'">
				and r.STATUS_NO = 10
				and distributor = #{mid}
			</if>
		</where> 
	</select>
	
	<select id="selectRequestDone" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from request_process rp, requests r
		<where>rp.rno = r.rno
		
			<if test="mtype == 'pm'">
				and r.STATUS_NO = 13 
				and pm = #{mid}
			</if>
			<if test="mtype == 'developer'">
				and r.STATUS_NO = 5
				and developer = #{mid}
			</if>
			<if test="mtype == 'tester'">
				and r.STATUS_NO = 7
				and tester = #{mid}
			</if>
			<if test="mtype == 'usertester'">
				and r.STATUS_NO = 9
				and user_tester = #{mid}
			</if>
			<if test="mtype == 'distributor'">
				and r.STATUS_NO = 11
				and distributor = #{mid}
			</if>
		</where> 
	</select>
	<select id="selectRequestReexam" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from request_process rp, requests r
		where rp.rno = r.rno
		and r.STATUS_NO = 3
		and developer = #{mid}
	</select>
	<select id="selectRequestReject" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*)
		from status_histories
		where NEXT_STATUS = 12 
		and WRITER =  #{mid}
	</select>
	
	<select id="selectListOf7daysLeft" parameterType="com.oti.srm.dto.Member" resultType="com.oti.srm.dto.Request">
		SELECT 
			r.RNO as "rno",
			REQ_TITLE as "reqTitle",
			REQ_DATE as "reqDate", 
		<if test="mtype == 'pm'">ALL_EXPECT_DATE as "ddayExpectDate"</if>
		<if test="mtype == 'developer'"> DEV_EXPECT_DATE as "ddayExpectDate"</if>
		<if test="mtype == 'tester'">TEST_EXPECT_DATE as "ddayExpectDate"</if>
		<if test="mtype == 'usertester'">USERTEST_EXPECT_DATE as "ddayExpectDate"</if>
		<if test="mtype == 'distributor'">DIST_EXPECT_DATE as "ddayExpectDate"</if>
		FROM request_process rp, requests r
		<where> rp.rno = r.rno
		
			<if test="mtype == 'pm'">
				and (ALL_EXPECT_DATE-sysdate) <![CDATA[<=]]>7
				and pm = #{mid}
		    	and ALL_EXPECT_DATE is not null
				and ALL_COMP_DATE is null
			</if>
			<if test="mtype == 'developer'">
				and (DEV_EXPECT_DATE-sysdate)<![CDATA[<=]]> 7
				and DEV_EXPECT_DATE is not null
				and DEV_COMP_DATE is null
				and developer = #{mid}
			</if>
			<if test="mtype == 'tester'">
				and (TEST_EXPECT_DATE-sysdate) <![CDATA[<=]]>7
				and TEST_EXPECT_DATE is not null
				and TEST_COMP_DATE is null
				and tester = #{mid}
			</if>
			<if test="mtype == 'usertester'">
				and (USERTEST_EXPECT_DATE-sysdate) <![CDATA[<=]]>7
				and USERTEST_EXPECT_DATE is not null
		   		and USERTEST_COMP_DATE is null
				and user_tester = #{mid}
			</if>
			<if test="mtype == 'distributor'">
				and (DIST_EXPECT_DATE-sysdate) <![CDATA[<=]]>7
				and DIST_EXPECT_DATE is not null
				and DIST_COMP_DATE is null
				and distributor = #{mid}
			</if>
		</where>
			<if test="mtype == 'pm'">
				order by (ALL_EXPECT_DATE-sysdate) asc
			</if>
			<if test="mtype == 'developer'">
				order by (DEV_EXPECT_DATE-sysdate) asc
			</if>
			<if test="mtype == 'tester'">
				order by (TEST_EXPECT_DATE-sysdate) asc
			</if>
			<if test="mtype == 'usertester'">
				order by (USERTEST_EXPECT_DATE-sysdate) asc
			</if>
			<if test="mtype == 'distributor'">
				order by (DIST_EXPECT_DATE-sysdate) asc
			</if>
	</select>
	
	<select id="selectAllMyRequests" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*) 
		from request_process
		<where>			
			<if test="mtype == 'pm'">
			 PM = #{mid}
			 and ALL_EXPECT_DATE is not null
			 and ALL_COMP_DATE is not null
			</if>
			<if test="mtype == 'developer'">
			 DEVELOPER = #{mid}
			and DEV_EXPECT_DATE is not null
			and DEV_COMP_DATE is not null
			</if>
			<if test="mtype == 'tester'">
			 TESTER = #{mid}
			 and TEST_EXPECT_DATE is not null
			 and TEST_COMP_DATE is not null
			</if>
			<if test="mtype == 'usertester'">
		   	 USER_TESTER = #{mid}
		   	 and USERTEST_EXPECT_DATE is not null
		   	 and USERTEST_COMP_DATE is not null
			</if>
			<if test="mtype == 'distributor'">
			 DISTRIBUTOR = #{mid}
			 and DIST_EXPECT_DATE is not null
			 and DIST_COMP_DATE is not null
			</if>
		</where>
	</select>
	<select id="selectDelayRequests" parameterType="com.oti.srm.dto.Member" resultType="int">
		select count(*) 
		from request_process
		<where>			
			<if test="mtype == 'pm'">
			 PM = #{mid}
			 and ALL_EXPECT_DATE is not null
			 and ALL_COMP_DATE is not null
			 and ALL_EXPECT_DATE <![CDATA[<]]> ALL_COMP_DATE
			</if>
			<if test="mtype == 'developer'">
			 DEVELOPER = #{mid}
			and DEV_EXPECT_DATE is not null
			and DEV_COMP_DATE is not null
			and DEV_EXPECT_DATE <![CDATA[<]]> DEV_COMP_DATE
			</if>
			<if test="mtype == 'tester'">
			 TESTER = #{mid}
			 and TEST_EXPECT_DATE is not null
			 and TEST_COMP_DATE is not null
			 and TEST_EXPECT_DATE <![CDATA[<]]> TEST_COMP_DATE
			</if>
			<if test="mtype == 'usertester'">
		   	 USER_TESTER = #{mid}
		   	 and USERTEST_EXPECT_DATE is not null
		   	 and USERTEST_COMP_DATE is not null
		   	 and USERTEST_EXPECT_DATE <![CDATA[<]]> USERTEST_COMP_DATE
			</if>
			<if test="mtype == 'distributor'">
			 DISTRIBUTOR = #{mid}
			 and DIST_EXPECT_DATE is not null
			 and DIST_COMP_DATE is not null
			 and DIST_EXPECT_DATE <![CDATA[<]]> DIST_COMP_DATE
			</if>
		</where>
	</select>
	<select id="selectFile" parameterType="int" resultType="com.oti.srm.dto.StatusHistoryFile">
		<![CDATA[
			select fno,
			file_name as "fileName",
			file_data as "fileData", 
			file_type as "fileType"
			from STATUS_HISTORIES_FILES
			where FNO = #{fno}
		
		]]>
	</select>
	
</mapper>